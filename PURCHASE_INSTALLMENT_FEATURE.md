# 💳 توثيق ميزة تقسيط المعاملات من نموذج الشراء

## 🎯 نظرة عامة

تم إضافة ميزة **تقسيط المعاملات** مباشرة من نموذج إضافة عملية الشراء، مما يسمح للمستخدم بتحويل أي عملية شراء إلى تقسيط بسهولة.

**التاريخ**: 2025-10-10  
**الملف المعدل**: `src/components/cards/add-purchase-dialog.tsx`

---

## ✅ الميزات المنفذة

### 1️⃣ مفتاح تبديل التقسيط

**الموقع**: في نموذج إضافة عملية الشراء، بعد خيار "استثناء من الكاش باك"

**الوصف**:
- ✅ مفتاح تبديل (Switch) بعنوان "تقسيط المعاملة"
- ✅ افتراضياً: معطل
- ✅ عند التفعيل: تظهر حقول التقسيط
- ✅ لون أزرق (#2563eb) للتمييز
- ✅ نص توضيحي: "تقسيم المبلغ على عدة أشهر مع إمكانية إضافة فوائد ومصاريف"

---

### 2️⃣ حقول التقسيط

**تظهر فقط عند تفعيل مفتاح التقسيط**

#### أ. عدد الأشهر (إلزامي):
- **النوع**: Number Input
- **القيم**: من 3 إلى 60 شهر
- **القيمة الافتراضية**: 12 شهر
- **التحقق**: مطلوب عند تفعيل التقسيط

#### ب. نسبة الفائدة (اختياري):
- **النوع**: Number Input
- **القيم**: من 0% فما فوق
- **القيمة الافتراضية**: 1.5%
- **ملاحظة**: 0 للتقسيط بدون فوائد

#### ج. المصاريف الإدارية (اختياري):
- **النوع**: Number Input
- **القيم**: من 0 فما فوق
- **القيمة الافتراضية**: 120 جنيه
- **ملاحظة**: تضاف للقسط الأول فقط

---

## 🧮 الحسابات المطبقة

### 1. حساب الفائدة الإجمالية:
```javascript
إجمالي الفائدة = (مبلغ المعاملة × نسبة الفائدة ÷ 100)
```

**مثال**:
- مبلغ المعاملة: 12,000 جنيه
- نسبة الفائدة: 1.5%
- إجمالي الفائدة: 12,000 × 1.5 ÷ 100 = **180 جنيه**

---

### 2. حساب المبلغ بعد الفائدة:
```javascript
المبلغ بعد الفائدة = مبلغ المعاملة + إجمالي الفائدة
```

**مثال**:
- مبلغ المعاملة: 12,000 جنيه
- إجمالي الفائدة: 180 جنيه
- المبلغ بعد الفائدة: 12,000 + 180 = **12,180 جنيه**

---

### 3. حساب القسط الشهري الأساسي:
```javascript
القسط الشهري الأساسي = المبلغ بعد الفائدة ÷ عدد الأشهر
```

**مثال**:
- المبلغ بعد الفائدة: 12,180 جنيه
- عدد الأشهر: 12 شهر
- القسط الشهري الأساسي: 12,180 ÷ 12 = **1,015 جنيه**

---

### 4. حساب القسط الأول:
```javascript
القسط الأول = القسط الشهري الأساسي + المصاريف الإدارية الكاملة
```

**مثال**:
- القسط الأساسي: 1,015 جنيه
- المصاريف الإدارية: 120 جنيه
- القسط الأول: 1,015 + 120 = **1,135 جنيه**

---

### 5. الأقساط المتبقية:
```javascript
القسط الشهري (من الشهر 2 حتى النهاية) = القسط الشهري الأساسي فقط
```

**مثال**:
- القسط الشهري: **1,015 جنيه** (ثابت لجميع الأشهر من 2 إلى 12)

---

### 6. التكلفة الإجمالية:
```javascript
التكلفة الإجمالية = مبلغ المعاملة + إجمالي الفائدة + المصاريف الإدارية
```

**مثال**:
- مبلغ المعاملة: 12,000 جنيه
- إجمالي الفائدة: 180 جنيه
- المصاريف الإدارية: 120 جنيه
- التكلفة الإجمالية: 12,000 + 180 + 120 = **12,300 جنيه**

---

## 📊 ملخص الحسابات في النموذج

**عند تفعيل التقسيط، يظهر ملخص مفصل يتضمن**:

1. ✅ **مبلغ المعاملة الأصلي**: المبلغ قبل أي إضافات
2. ✅ **نسبة الفائدة**: النسبة المئوية المطبقة
3. ✅ **إجمالي الفائدة**: المبلغ الإجمالي للفائدة
4. ✅ **المصاريف الإدارية**: المصاريف الثابتة
5. ✅ **عدد الأشهر**: مدة التقسيط
6. ✅ **القسط الأول**: القسط الأساسي + المصاريف الإدارية
7. ✅ **القسط الشهري**: القسط الأساسي فقط (من الشهر 2)
8. ✅ **التكلفة الإجمالية**: المبلغ النهائي الكلي

**الألوان**:
- 🔵 أزرق (#2563eb) للأقساط الشهرية
- 🔴 أحمر (#dc2626) للفوائد والمصاريف والتكلفة الإجمالية
- 🟠 برتقالي (#ea580c) لنسبة الفائدة

---

## 💾 حفظ البيانات

### 1. بيانات المعاملة:

**يتم حفظ المعاملة مع علامة تقسيط**:
```javascript
{
  id: "timestamp",
  type: "withdrawal",
  amount: totalAmount,
  baseAmount: amount,
  purchaseFee: purchaseFee,
  cashback: cashback,
  excludedFromCashback: excludeFromCashback,
  description: "...",
  merchant: "...",
  category: "...",
  transactionDate: "...",
  cardId: "...",
  isInstallment: true  // ← علامة التقسيط
}
```

---

### 2. بيانات التقسيط:

**يتم إنشاء سجل تقسيط جديد في localStorage**:
```javascript
{
  id: "timestamp_inst",
  cardId: "1",
  merchantName: "كارفور",
  merchantId: "1",
  totalAmount: 12000,
  monthlyPayment: 1015,
  baseMonthlyPayment: 1015,
  monthlyInterest: 15,
  monthlyAdminFees: 0,
  totalMonths: 12,
  paidMonths: 0,
  remainingMonths: 12,
  startDate: "2025-01-10",
  endDate: "2026-01-10",
  installmentType: "with-interest",
  interestRate: 1.5,
  administrativeFees: 120,
  totalInterest: 180,
  totalAdminFees: 120,
  totalCost: 12300,
  status: "active",
  nextPaymentDate: "2025-02-10",
  nextPaymentAmount: 1135,
  firstPayment: 1135,
  createdAt: "2025-01-10T12:00:00.000Z",
  purchaseId: "timestamp"
}
```

**المفتاح في localStorage**: `installments_{cardId}`

---

## 🔗 ربط مع تبويب التقسيط

**عند إضافة معاملة مقسطة**:
1. ✅ يتم حفظ المعاملة في قائمة المعاملات
2. ✅ يتم إنشاء سجل تقسيط جديد
3. ✅ يتم حفظ التقسيط في localStorage
4. ✅ يظهر التقسيط تلقائياً في تبويب "التقسيط"
5. ✅ يتم تحديث الإحصائيات تلقائياً

---

## 📋 ربط مع كشف الحساب

**في كشف الحساب الشهري**:

### الشهر الأول:
- **المبلغ**: القسط الأول (القسط الأساسي + المصاريف الإدارية)
- **مثال**: 1,135 جنيه
- **النوع**: "قسط شهري - كارفور"

### الأشهر المتبقية (2-12):
- **المبلغ**: القسط الشهري الأساسي فقط
- **مثال**: 1,015 جنيه
- **النوع**: "قسط شهري - كارفور"

---

## 🎨 التصميم

### الألوان:
- **خلفية قسم التقسيط**: `bg-blue-50 dark:bg-blue-950/30`
- **حدود**: `border-blue-200 dark:border-blue-700`
- **النصوص**: `#2563eb` (أزرق)
- **الفوائد والمصاريف**: `#dc2626` (أحمر)

### الأيقونات:
- **Calculator**: لعنوان "تفاصيل التقسيط"
- **AlertCircle**: للملاحظات الهامة

---

## 🚀 الاستخدام

### خطوات إضافة معاملة مقسطة:

```
1. افتح صفحة تفاصيل البطاقة: http://localhost:3003/cards/1
2. انقر على زر "شراء" 🛒
3. املأ بيانات المعاملة:
   - المبلغ: 12,000
   - الوصف: شراء من كارفور
   - المكان: كارفور
   - الفئة: طعام ومشروبات
4. فعّل مفتاح "تقسيط المعاملة" ✅
5. أدخل تفاصيل التقسيط:
   - عدد الأشهر: 12
   - نسبة الفائدة: 1.5%
   - المصاريف الإدارية: 120
6. شاهد ملخص الحسابات التلقائي
7. انقر "إضافة العملية"
```

**النتيجة**:
- ✅ تمت إضافة المعاملة
- ✅ تم إنشاء سجل التقسيط
- ✅ يظهر في تبويب "التقسيط"
- ✅ تحديث الإحصائيات

---

## 📊 مثال عملي كامل

### البيانات المدخلة:
- **مبلغ المعاملة**: 12,000 جنيه
- **التاجر**: كارفور
- **عدد الأشهر**: 12 شهر
- **نسبة الفائدة**: 1.5%
- **المصاريف الإدارية**: 120 جنيه

### الحسابات:
1. **إجمالي الفائدة**: 12,000 × 1.5% = **180 جنيه**
2. **المبلغ بعد الفائدة**: 12,000 + 180 = **12,180 جنيه**
3. **القسط الأساسي**: 12,180 ÷ 12 = **1,015 جنيه**
4. **القسط الأول**: 1,015 + 120 = **1,135 جنيه**
5. **الأقساط المتبقية**: **1,015 جنيه** × 11 شهر
6. **التكلفة الإجمالية**: 12,000 + 180 + 120 = **12,300 جنيه**

### ما يظهر في كشف الحساب:
| الشهر | المبلغ | الوصف |
|-------|--------|-------|
| 1 | 1,135 جنيه | قسط شهري - كارفور (مع مصاريف) |
| 2-12 | 1,015 جنيه | قسط شهري - كارفور |

---

## ✅ الخلاصة

تم تطوير ميزة تقسيط المعاملات بنجاح مع:

**الميزات**:
- ✅ مفتاح تبديل سهل الاستخدام
- ✅ 3 حقول للتقسيط (أشهر، فائدة، مصاريف)
- ✅ حسابات تلقائية دقيقة
- ✅ ملخص مفصل وواضح
- ✅ حفظ تلقائي في localStorage
- ✅ ربط مع تبويب التقسيط
- ✅ دعم كامل للوضع الليلي

**الحسابات**: 6 معادلات دقيقة  
**الحالة**: ✅ **مكتمل وجاهز للاستخدام!**

---

**تم التطوير بواسطة**: Augment Agent  
**التاريخ**: 2025-10-10  
**الإصدار**: 1.0.0

