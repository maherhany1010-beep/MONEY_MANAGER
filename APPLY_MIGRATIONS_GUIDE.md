# ๐ ุฏููู ุชุทุจูู Database Migrations

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุชุทุจูู migrations ุนูู ูุงุนุฏุฉ ุจูุงูุงุช Supabase ุฎุทูุฉ ุจุฎุทูุฉ.

---

## โก ุงูุทุฑููุฉ ุงูุณุฑูุนุฉ (ููุตู ุจูุง)

### ุงูุฎุทูุฉ 1: ุชุดุบูู Migration Script

```bash
npm run migrate
```

ูุฐุง ุงูุณูุฑูุจุช ุณูุนุฑุถ ูู ูุญุชูู ูู migration ููุฑุดุฏู ุฎุทูุฉ ุจุฎุทูุฉ.

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงููุฌุงุญ

```bash
npm run migrate:verify
```

ูุฐุง ุงูุณูุฑูุจุช ุณูุชุญูู ูู:
- โ ูุฌูุฏ ุฌููุน ุงูุฌุฏุงูู
- โ ุฅููุงููุฉ ุงููุตูู ููุฌุฏุงูู
- โ ุนูููุงุช ุงูุจูุงูุงุช (ุฅุถุงูุฉ/ุญุฐู)

---

## ๐ ุงูุทุฑููุฉ ุงููุฏููุฉ (ุฎุทูุฉ ุจุฎุทูุฉ)

### ุงูุฎุทูุฉ 1: ูุชุญ Supabase Dashboard

1. ุงูุชุญ ูุชุตูุญู
2. ุงุฐูุจ ุฅูู: https://app.supabase.com
3. ุณุฌูู ุฏุฎูู
4. ุงุฎุชุฑ ูุดุฑูุนู: `jzcvhxxuhiqblqttpjjg`

### ุงูุฎุทูุฉ 2: ูุชุญ SQL Editor

1. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉุ ุงุฎุชุฑ **SQL Editor**
2. ุฃู ุงุฐูุจ ูุจุงุดุฑุฉ ุฅูู:
   ```
   https://app.supabase.com/project/jzcvhxxuhiqblqttpjjg/sql
   ```

### ุงูุฎุทูุฉ 3: ุชุทุจูู Migration 001

1. ุงูุชุญ ููู: `supabase/migrations/001_create_missing_tables.sql`
2. ุงูุณุฎ ุงููุญุชูู ุจุงููุงูู (Ctrl+A ุซู Ctrl+C)
3. ุงูุตู ูู SQL Editor (Ctrl+V)
4. ุงุถุบุท **Run** ุฃู ุงุถุบุท `Ctrl+Enter`
5. ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ "Success"

**ูุง ููุนูู ูุฐุง Migration:**
- โ ุฅูุดุงุก 15 ุฌุฏูู ุฌุฏูุฏ
- โ ุฅุถุงูุฉ Indexes ููุฃุฏุงุก
- โ ุฅุถุงูุฉ Foreign Keys
- โ ุฅุถุงูุฉ Constraints

**ุงูุฌุฏุงูู ุงูุชู ุณูุชู ุฅูุดุงุคูุง:**
1. `bank_accounts` - ุงูุญุณุงุจุงุช ุงูุจูููุฉ
2. `e_wallets` - ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ
3. `cash_vaults` - ุงูุฎุฒุงุฆู ุงูููุฏูุฉ
4. `prepaid_cards` - ุงูุจุทุงูุงุช ุงููุฏููุนุฉ ูุณุจูุงู
5. `customers` - ุงูุนููุงุก
6. `products` - ุงูููุชุฌุงุช
7. `sales_invoices` - ููุงุชูุฑ ุงููุจูุนุงุช
8. `invoice_items` - ุนูุงุตุฑ ุงููุงุชูุฑุฉ
9. `pos_machines` - ุฃุฌูุฒุฉ ููุงุท ุงูุจูุน
10. `savings_circles` - ุฏูุงุฆุฑ ุงูุงุฏุฎุงุฑ
11. `investments` - ุงูุงุณุชุซูุงุฑุงุช
12. `merchants` - ุงูุชุฌุงุฑ
13. `central_transfers` - ุงูุชุญูููุงุช ุงููุฑูุฒูุฉ
14. `cashback` - ุงูุงุณุชุฑุฏุงุฏ ุงูููุฏู
15. `reconciliation` - ุงูุชุณููุฉ

### ุงูุฎุทูุฉ 4: ุชุทุจูู Migration 002

1. ุงูุชุญ ููู: `supabase/migrations/002_enable_rls_policies.sql`
2. ุงูุณุฎ ุงููุญุชูู ุจุงููุงูู
3. ุงูุตู ูู SQL Editor (ุงูุณุญ ุงููุญุชูู ุงูุณุงุจู ุฃููุงู)
4. ุงุถุบุท **Run**
5. ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ "Success"

**ูุง ููุนูู ูุฐุง Migration:**
- โ ุชูุนูู Row Level Security (RLS) ุนูู ุฌููุน ุงูุฌุฏุงูู
- โ ุฅูุดุงุก 4 policies ููู ุฌุฏูู:
  - `SELECT` - ูุฑุงุกุฉ ุงูุจูุงูุงุช
  - `INSERT` - ุฅุถุงูุฉ ุจูุงูุงุช
  - `UPDATE` - ุชุญุฏูุซ ุจูุงูุงุช
  - `DELETE` - ุญุฐู ุจูุงูุงุช

**ุงูุฃูุงู:**
- ๐ ูู ูุณุชุฎุฏู ูุฑู ุจูุงูุงุชู ููุท
- ๐ ูุง ูููู ุงููุตูู ูุจูุงูุงุช ูุณุชุฎุฏููู ุขุฎุฑูู
- ๐ ุฌููุน ุงูุนูููุงุช ูุญููุฉ ุจู `auth.uid() = user_id`

### ุงูุฎุทูุฉ 5: ุชุทุจูู Migration 003

1. ุงูุชุญ ููู: `supabase/migrations/003_create_triggers.sql`
2. ุงูุณุฎ ุงููุญุชูู ุจุงููุงูู
3. ุงูุตู ูู SQL Editor
4. ุงุถุบุท **Run**
5. ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ "Success"

**ูุง ููุนูู ูุฐุง Migration:**
- โ ุฅูุดุงุก function ูุชุญุฏูุซ `updated_at` ุชููุงุฆูุงู
- โ ุฅุถุงูุฉ triggers ุนูู 12 ุฌุฏูู
- โ ุชุญุฏูุซ `updated_at` ุนูุฏ ูู UPDATE

---

## โ ุงูุชุญูู ูู ุงููุฌุงุญ

### 1. ุงูุชุญูู ูู ุงูุฌุฏุงูู

ูู SQL Editorุ ูููุฐ:

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- ูุฌุจ ุฃู ุชุฑู **19 ุฌุฏูู ุนูู ุงูุฃูู**
- 4 ุฌุฏุงูู ููุฌูุฏุฉ ูุณุจูุงู + 15 ุฌุฏูู ุฌุฏูุฏ

### 2. ุงูุชุญูู ูู RLS

ูู SQL Editorุ ูููุฐ:

```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY tablename;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- `rowsecurity` ูุฌุจ ุฃู ูููู `true` ูุฌููุน ุงูุฌุฏุงูู

### 3. ุงูุชุญูู ูู Policies

ูู SQL Editorุ ูููุฐ:

```sql
SELECT tablename, policyname, cmd
FROM pg_policies 
WHERE schemaname = 'public' 
ORDER BY tablename, policyname;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- 4 policies ููู ุฌุฏูู (SELECT, INSERT, UPDATE, DELETE)
- ุงููุฌููุน: ~60 policy

### 4. ุงูุชุญูู ูู Triggers

ูู SQL Editorุ ูููุฐ:

```sql
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public'
ORDER BY event_object_table;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- trigger ูุงุญุฏ ููู ุฌุฏูู ูุญุชูู ุนูู `updated_at`
- ุงููุฌููุน: ~12 trigger

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: "relation already exists"

**ุงูุณุจุจ:** ุงูุฌุฏูู ููุฌูุฏ ูุณุจูุงู

**ุงูุญู:**
- โ ูุฐุง ุทุจูุนู ุฅุฐุง ููุช ุชุนูุฏ ุชุทุจูู migration
- โ ููููู ุชุฌุงูู ูุฐุง ุงูุฎุทุฃ
- โ ุฃู ุงุญุฐู ุงูุฌุฏูู ุฃููุงู:
  ```sql
  DROP TABLE IF EXISTS table_name CASCADE;
  ```

### ุฎุทุฃ: "policy already exists"

**ุงูุณุจุจ:** ุงูู policy ููุฌูุฏุฉ ูุณุจูุงู

**ุงูุญู:**
- โ ูุฐุง ุทุจูุนู ุฅุฐุง ููุช ุชุนูุฏ ุชุทุจูู migration
- โ ููููู ุชุฌุงูู ูุฐุง ุงูุฎุทุฃ
- โ ุฃู ุงุญุฐู ุงูู policy ุฃููุงู:
  ```sql
  DROP POLICY IF EXISTS policy_name ON table_name;
  ```

### ุฎุทุฃ: "permission denied"

**ุงูุณุจุจ:** ููุณ ูุฏูู ุตูุงุญูุงุช ูุงููุฉ

**ุงูุญู:**
- โ ุชุฃูุฏ ุฃูู ูุณุฌู ุฏุฎูู ูู Owner ูููุดุฑูุน
- โ ุชุฃูุฏ ุฃูู ูู ุงููุดุฑูุน ุงูุตุญูุญ

### ุฎุทุฃ: "syntax error"

**ุงูุณุจุจ:** ุฎุทุฃ ูู SQL

**ุงูุญู:**
- โ ุชุฃูุฏ ุฃูู ูุณุฎุช ุงููุญุชูู ุจุงููุงูู
- โ ุชุฃูุฏ ุฃูู ูู ุชุนุฏูู ุนูู SQL
- โ ุฌุฑูุจ ูุณุฎ ููุตู ูุฑุฉ ุฃุฎุฑู

---

## ๐ ุงูุญุงูุฉ ุงูุญุงููุฉ

### ูุจู Migrations:
- โ 4 ุฌุฏุงูู ููุท
- โ ูุนุธู ุงูุจูุงูุงุช ูู localStorage
- โ ูุง real-time sync
- โ ูุง ูุณุฎ ุงุญุชูุงุทู

### ุจุนุฏ Migrations:
- โ 19 ุฌุฏูู
- โ ุฌููุน ุงูุจูุงูุงุช ูู Supabase
- โ Real-time sync ุฌุงูุฒ
- โ ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู
- โ RLS ูุญูู
- โ Triggers ุชููุงุฆูุฉ

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุชุทุจูู Migrations ุจูุฌุงุญ:

### 1. ุชุญุฏูุซ Contexts โ

ุชู ุชุญุฏูุซ:
- โ `bank-accounts-context.tsx`

ูุฌุจ ุชุญุฏูุซ:
- โณ `e-wallets-context.tsx`
- โณ `cash-vaults-context.tsx`
- โณ `prepaid-cards-context.tsx`
- โณ ... (14 context ุขุฎุฑ)

### 2. ุงุฎุชุจุงุฑ ุงูุชุทุจูู

```bash
npm run dev
```

- ุงูุชุญ http://localhost:3000
- ุณุฌูู ุฏุฎูู
- ุฌุฑูุจ ุฅุถุงูุฉ ุญุณุงุจ ุจููู
- ุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช ูู Supabase

### 3. ุงุฎุชุจุงุฑ Real-time

- ุงูุชุญ ุงูุชุทุจูู ูู ูุงูุฐุชูู
- ุฃุถู ุญุณุงุจ ูู ูุงูุฐุฉ
- ูุฌุจ ุฃู ูุธูุฑ ุชููุงุฆูุงู ูู ุงููุงูุฐุฉ ุงูุฃุฎุฑู

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:

1. **ุฑุงุฌุน ุงุณุชูุดุงู ุงูุฃุฎุทุงุก** ุฃุนูุงู
2. **ุชุญูู ูู Supabase Logs:**
   - ุงุฐูุจ ุฅูู: Database โ Logs
3. **ุชุญูู ูู Console ูู ุงููุชุตูุญ:**
   - ุงุถุบุท F12
   - ุงุฐูุจ ุฅูู Console
   - ุงุจุญุซ ุนู ุฃุฎุทุงุก

---

**ุขุฎุฑ ุชุญุฏูุซ:** 30 ุฃูุชูุจุฑ 2025  
**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุชุทุจูู โ

