# 🚫 ميزة استثناء المعاملات من الكاش باك

## 📋 نظرة عامة

تم إضافة ميزة جديدة تتيح للمستخدم **استثناء معاملات شراء معينة من الكاش باك** أثناء عملية الشراء.

هذه الميزة مفيدة في الحالات التالية:
- 💳 معاملات لا تستحق كاش باك (حسب سياسة البنك)
- 🏦 معاملات حكومية أو رسوم
- 💰 سحب نقدي أو تحويلات
- 🎰 معاملات في فئات مستثناة (مثل القمار، العملات الرقمية)
- 📝 أي معاملة يرغب المستخدم في استثنائها يدوياً

---

## 🎯 الميزات المنفذة

### ✅ 1. خيار الاستثناء في نموذج الشراء
- ✅ مفتاح تبديل (Switch) لتفعيل/تعطيل الاستثناء
- ✅ تصميم مميز بلون كهرماني (Amber) للفت الانتباه
- ✅ نص توضيحي: "لن يتم احتساب كاش باك على هذه المعاملة"
- ✅ دعم الوضع الليلي (Dark Mode)

### ✅ 2. حساب الكاش باك الديناميكي
- ✅ عند تفعيل الاستثناء: الكاش باك = 0
- ✅ عند تعطيل الاستثناء: الكاش باك = المبلغ × نسبة الكاش باك

### ✅ 3. ملخص العملية المحدث
- ✅ إخفاء سطر الكاش باك عند الاستثناء
- ✅ عرض رسالة تنبيه: "تم استثناء هذه المعاملة من الكاش باك"
- ✅ تصميم الرسالة بلون كهرماني مع أيقونة تنبيه

### ✅ 4. حفظ معلومة الاستثناء
- ✅ إضافة حقل `excludedFromCashback` في بيانات المعاملة
- ✅ يمكن استخدامه لاحقاً في التقارير والإحصائيات

---

## 🏗️ التفاصيل التقنية

### 1. التعديلات على الكود

**الملف**: `src/components/cards/add-purchase-dialog.tsx`

#### أ. إضافة State للاستثناء:
```typescript
const [excludeFromCashback, setExcludeFromCashback] = useState(false)
```

#### ب. تعديل حساب الكاش باك:
```typescript
// قبل التعديل:
const cashback = amount * (card.cashbackRate || 0) / 100

// بعد التعديل:
const cashback = excludeFromCashback ? 0 : (amount * (card.cashbackRate || 0) / 100)
```

#### ج. إضافة الحقل في بيانات المعاملة:
```typescript
const purchase = {
  id: Date.now().toString(),
  type: 'withdrawal',
  amount: totalAmount,
  baseAmount: amount,
  purchaseFee: purchaseFee,
  cashback: cashback,
  excludedFromCashback: excludeFromCashback, // ✅ جديد
  description: formData.description,
  merchant: formData.merchantName || formData.merchantId,
  category: formData.category,
  transactionDate: new Date(formData.date).toISOString(),
  cardId: card.id,
}
```

#### د. إعادة تعيين القيمة عند إغلاق النموذج:
```typescript
setExcludeFromCashback(false)
```

---

### 2. واجهة المستخدم

#### أ. مفتاح التبديل (Switch):
```tsx
<div className="flex items-center justify-between p-3 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-200 dark:border-amber-700">
  <div className="flex-1">
    <div className="flex items-center gap-2">
      <Label htmlFor="exclude-cashback" className="cursor-pointer font-medium dark:text-amber-100" style={{ color: '#d97706' }}>
        استثناء من الكاش باك
      </Label>
    </div>
    <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
      لن يتم احتساب كاش باك على هذه المعاملة
    </p>
  </div>
  <Switch
    id="exclude-cashback"
    checked={excludeFromCashback}
    onCheckedChange={setExcludeFromCashback}
  />
</div>
```

#### ب. رسالة التنبيه في الملخص:
```tsx
{excludeFromCashback && (
  <div className="flex items-center gap-2 p-2 bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-600 rounded text-xs dark:text-amber-200" style={{ color: '#d97706' }}>
    <AlertCircle className="h-4 w-4" />
    <span>تم استثناء هذه المعاملة من الكاش باك</span>
  </div>
)}
```

---

## 🎨 التصميم

### الألوان المستخدمة:

| العنصر | Light Mode | Dark Mode |
|--------|-----------|-----------|
| **الخلفية** | `bg-amber-50` | `bg-amber-950/30` |
| **الحدود** | `border-amber-200` | `border-amber-700` |
| **النص** | `#d97706` (Amber-600) | `text-amber-100` |
| **رسالة التنبيه** | `bg-amber-100` | `bg-amber-900/30` |

### الأيقونات:
- ⚠️ `AlertCircle`: أيقونة التنبيه في رسالة الاستثناء

---

## 📊 سير العمل (Workflow)

### السيناريو 1: شراء عادي (بدون استثناء)

```
المستخدم → يفتح نموذج الشراء
         ↓
    يملأ البيانات:
    - المبلغ: 1000 جنيه
    - المكان: كارفور
    - الفئة: طعام ومشروبات
         ↓
    مفتاح الاستثناء: ❌ معطل (افتراضي)
         ↓
    الكاش باك المحسوب:
    1000 × 2.5% = 25 جنيه ✅
         ↓
    ملخص العملية:
    - مبلغ الشراء: 1000 جنيه
    - كاش باك: -25 جنيه
    - صافي التكلفة: 975 جنيه
         ↓
    حفظ المعاملة:
    - cashback: 25
    - excludedFromCashback: false
```

---

### السيناريو 2: شراء مستثنى من الكاش باك

```
المستخدم → يفتح نموذج الشراء
         ↓
    يملأ البيانات:
    - المبلغ: 500 جنيه
    - المكان: مصلحة الضرائب
    - الفئة: فواتير
         ↓
    مفتاح الاستثناء: ✅ مفعّل
         ↓
    الكاش باك المحسوب:
    0 جنيه (مستثنى) ❌
         ↓
    ملخص العملية:
    - مبلغ الشراء: 500 جنيه
    - ⚠️ تم استثناء هذه المعاملة من الكاش باك
    - (لا يظهر سطر الكاش باك)
    - (لا يظهر صافي التكلفة)
         ↓
    حفظ المعاملة:
    - cashback: 0
    - excludedFromCashback: true
```

---

## 🧪 اختبار الميزة

### اختبار 1: شراء عادي (3 دقائق)

**الخطوات**:
1. ✅ افتح صفحة البطاقة: `http://localhost:3003/cards/1`
2. ✅ انقر زر **"شراء"** 🛒
3. ✅ املأ البيانات:
   - المبلغ: `1000`
   - الوصف: `تسوق من كارفور`
   - المكان: اختر من القائمة
   - الفئة: `طعام ومشروبات`
4. ✅ **لا تفعّل** مفتاح "استثناء من الكاش باك"
5. ✅ تحقق من ملخص العملية:
   - مبلغ الشراء: `1,000.00 جنيه`
   - كاش باك (2.5%): `-25.00 جنيه` ✅
   - صافي التكلفة: `975.00 جنيه` ✅
6. ✅ انقر **"إضافة عملية الشراء"**

**النتيجة المتوقعة**:
- ✅ المعاملة تُضاف بنجاح
- ✅ الكاش باك = 25 جنيه
- ✅ `excludedFromCashback = false`

---

### اختبار 2: شراء مستثنى من الكاش باك (4 دقائق)

**الخطوات**:
1. ✅ افتح صفحة البطاقة: `http://localhost:3003/cards/1`
2. ✅ انقر زر **"شراء"** 🛒
3. ✅ املأ البيانات:
   - المبلغ: `500`
   - الوصف: `دفع رسوم حكومية`
   - المكان: (إدخال يدوي) `مصلحة الضرائب`
   - الفئة: `فواتير`
4. ✅ **فعّل** مفتاح "استثناء من الكاش باك" ✅
5. ✅ تحقق من ملخص العملية:
   - مبلغ الشراء: `500.00 جنيه`
   - ⚠️ رسالة: "تم استثناء هذه المعاملة من الكاش باك" ✅
   - **لا يظهر** سطر الكاش باك ❌
   - **لا يظهر** صافي التكلفة ❌
6. ✅ انقر **"إضافة عملية الشراء"**

**النتيجة المتوقعة**:
- ✅ المعاملة تُضاف بنجاح
- ✅ الكاش باك = 0 جنيه
- ✅ `excludedFromCashback = true`

---

### اختبار 3: التبديل بين الحالتين (3 دقائق)

**الخطوات**:
1. ✅ افتح نموذج الشراء
2. ✅ املأ المبلغ: `1000`
3. ✅ تحقق من الكاش باك: `25 جنيه` ✅
4. ✅ **فعّل** مفتاح الاستثناء
5. ✅ تحقق من اختفاء الكاش باك وظهور الرسالة ✅
6. ✅ **عطّل** مفتاح الاستثناء
7. ✅ تحقق من عودة الكاش باك: `25 جنيه` ✅

**النتيجة المتوقعة**:
- ✅ التبديل يعمل بشكل فوري
- ✅ الحسابات تتحدث ديناميكياً
- ✅ الرسائل تظهر/تختفي حسب الحالة

---

## 📈 الاستخدامات المستقبلية

### 1. التقارير والإحصائيات:
```typescript
// حساب إجمالي الكاش باك الفعلي
const totalCashback = transactions
  .filter(t => !t.excludedFromCashback)
  .reduce((sum, t) => sum + t.cashback, 0)

// حساب عدد المعاملات المستثناة
const excludedCount = transactions
  .filter(t => t.excludedFromCashback)
  .length
```

### 2. الفلاتر:
```typescript
// عرض المعاملات المستثناة فقط
const excludedTransactions = transactions
  .filter(t => t.excludedFromCashback)

// عرض المعاملات التي حصلت على كاش باك
const cashbackTransactions = transactions
  .filter(t => !t.excludedFromCashback && t.cashback > 0)
```

### 3. التنبيهات:
```typescript
// تنبيه إذا كانت نسبة المعاملات المستثناة عالية
const excludedPercentage = (excludedCount / transactions.length) * 100
if (excludedPercentage > 30) {
  alert('⚠️ أكثر من 30% من معاملاتك مستثناة من الكاش باك')
}
```

---

## 🎯 الفوائد

### للمستخدم:
- ✅ **دقة أعلى**: حساب كاش باك دقيق يعكس الواقع
- ✅ **مرونة**: التحكم في المعاملات التي تستحق كاش باك
- ✅ **شفافية**: معرفة أي معاملات لا تحصل على كاش باك
- ✅ **سهولة**: خيار بسيط وواضح في نموذج الشراء

### للنظام:
- ✅ **بيانات دقيقة**: تتبع المعاملات المستثناة
- ✅ **تقارير أفضل**: إحصائيات أكثر دقة
- ✅ **توافق**: يتماشى مع سياسات البنوك الفعلية
- ✅ **قابلية التوسع**: يمكن إضافة قواعد تلقائية لاحقاً

---

## 🔮 التطويرات المستقبلية المقترحة

### 1. الاستثناء التلقائي حسب الفئة:
```typescript
// إعدادات البطاقة
const excludedCategories = ['فواتير', 'رسوم حكومية', 'سحب نقدي']

// استثناء تلقائي
if (excludedCategories.includes(formData.category)) {
  setExcludeFromCashback(true)
}
```

### 2. الاستثناء التلقائي حسب المكان:
```typescript
// قائمة الأماكن المستثناة
const excludedMerchants = ['مصلحة الضرائب', 'البنك المركزي']

// استثناء تلقائي
if (excludedMerchants.includes(formData.merchantName)) {
  setExcludeFromCashback(true)
}
```

### 3. تقرير المعاملات المستثناة:
- 📊 عدد المعاملات المستثناة
- 💰 إجمالي المبالغ المستثناة
- 📈 نسبة الاستثناء من إجمالي المعاملات
- 📅 توزيع المعاملات المستثناة حسب الشهر

### 4. Badge في قائمة المعاملات:
```tsx
{transaction.excludedFromCashback && (
  <Badge variant="secondary" className="bg-amber-100 text-amber-800">
    مستثنى من الكاش باك
  </Badge>
)}
```

---

## 📚 الملفات المعدلة

| الملف | التعديلات | الأسطر |
|-------|-----------|--------|
| `src/components/cards/add-purchase-dialog.tsx` | إضافة ميزة الاستثناء | ~30 سطر |

---

## ✅ الخلاصة

تم إضافة ميزة **استثناء المعاملات من الكاش باك** بنجاح! 🎉

**الميزات الرئيسية**:
- ✅ مفتاح تبديل بسيط وواضح
- ✅ حساب ديناميكي للكاش باك
- ✅ رسائل تنبيه واضحة
- ✅ دعم كامل للوضع الليلي
- ✅ حفظ معلومة الاستثناء في بيانات المعاملة

**جاهز للاختبار**: `http://localhost:3003/cards/1` → زر "شراء" 🛒

---

**تم التطوير بواسطة**: Augment Agent  
**التاريخ**: 2025-10-09  
**الإصدار**: 1.0.0

